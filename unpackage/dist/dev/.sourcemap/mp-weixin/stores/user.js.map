{"version":3,"file":"user.js","sources":["stores/user.uts"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref, computed } from 'vue'\n\ninterface Address {\n  id: string\n  name: string\n  phone: string\n  campus: string\n  locationType: string\n  detail: string\n  isDefault: boolean\n}\n\ninterface UserInfo {\n  _id: string\n  nickname: string\n  avatar: string\n  campus: string\n  tags: string[]\n  gender?: string\n  contact?: string\n  addresses?: Address[]\n}\n\n// 登录返回类型\ninterface LoginResult {\n  success: boolean\n  message: string\n  userInfo?: UserInfo\n}\n\nexport const useUserStore = defineStore('user', () => {\n  // 状态定义\n  const userInfo = ref<UserInfo | null>(null)\n  const token = ref<string>('')\n\n  // 计算属性\n  const isLoggedIn = computed(() => !!token.value && !!userInfo.value)\n  const user = computed(() => userInfo.value)\n\n  // 设置用户信息\n  function setUserInfo(info: UserInfo) {\n    userInfo.value = info\n    uni.setStorageSync('userInfo', info)\n  }\n\n  // 设置Token\n  function setToken(newToken: string) {\n    token.value = newToken\n    uni.setStorageSync('token', newToken)\n  }\n\n  // 模拟登录（云函数未部署时的降级方案）\n  function loginMock(code: string): LoginResult {\n    const mockUserInfo: UserInfo = {\n      _id: 'user_' + Date.now(),\n      nickname: '校园用户',\n      avatar: '',\n      campus: '主校区',\n      tags: ['学习', '运动']\n    }\n    setToken(code)\n    setUserInfo(mockUserInfo)\n    return { success: true, message: '登录成功', userInfo: mockUserInfo }\n  }\n\n  // 登录方法 - 接收微信登录code\n  async function login(code: string): Promise<LoginResult> {\n    try {\n      const res = await uniCloud.callFunction({\n        name: 'uni-id-cf',\n        data: {\n          method: 'loginByWeixin',\n          code: code\n        }\n      })\n\n      if (res.result?.errCode === 0) {\n        // 云函数登录成功\n        const loginUserInfo: UserInfo = res.result.userInfo || {\n          _id: res.result.uid || 'user_' + Date.now(),\n          nickname: res.result.nickname || '校园用户',\n          avatar: res.result.avatar || '',\n          campus: res.result.campus || '主校区',\n          tags: res.result.tags || ['学习', '运动']\n        }\n        setToken(res.result.token || code)\n        setUserInfo(loginUserInfo)\n        return { success: true, message: '登录成功', userInfo: loginUserInfo }\n      }\n\n      // 云函数返回错误，使用模拟登录\n      console.warn('云函数登录失败，使用模拟登录:', res.result?.errMsg)\n      return loginMock(code)\n    } catch (error) {\n      console.error('云函数调用失败，使用模拟登录:', error)\n      // 云函数未部署或调用失败，使用模拟登录\n      return loginMock(code)\n    }\n  }\n\n  // 退出登录\n  async function logout() {\n    token.value = ''\n    userInfo.value = null\n    uni.removeStorageSync('token')\n    uni.removeStorageSync('userInfo')\n  }\n\n  // 检查登录状态 - 从本地存储恢复\n  function checkLoginStatus() {\n    const savedToken = uni.getStorageSync('token')\n    const savedUserInfo = uni.getStorageSync('userInfo')\n\n    if (savedToken) {\n      token.value = savedToken\n    }\n    if (savedUserInfo) {\n      userInfo.value = savedUserInfo\n    }\n  }\n\n  function updateProfile(profile: Partial<UserInfo>) {\n    if (userInfo.value) {\n      userInfo.value = { ...userInfo.value, ...profile }\n      uni.setStorageSync('userInfo', userInfo.value)\n    }\n  }\n\n  return {\n    userInfo,\n    token,\n    isLoggedIn,\n    user,\n    setUserInfo,\n    setToken,\n    login,\n    logout,\n    checkLoginStatus,\n    updateProfile\n  }\n})\n"],"names":["useUserStore","defineStore","userInfo","ref","token","isLoggedIn","computed","value","user","setUserInfo","info","uni","setStorageSync","setToken","newToken","loginMock","code","mockUserInfo","_id","Date","now","nickname","avatar","campus","tags","success","message","login","async","res","uniCloud","tr","callFunction","name","data","method","_a","result","errCode","loginUserInfo","uid","__f__","_b","errMsg","error","index","logout","removeStorageSync","checkLoginStatus","savedToken","getStorageSync","savedUserInfo","updateProfile","profile"],"mappings":"oDA+BaA,EAAeC,EAAAA,YAAY,QAAQ,KAExC,MAAAC,EAAWC,MAAqB,MAChCC,EAAQD,MAAY,IAGpBE,EAAaC,YAAS,MAAQF,EAAMG,SAAWL,EAASK,QACxDC,EAAOF,EAAAA,UAAS,IAAMJ,EAASK,QAGrC,SAASE,EAAYC,GACnBR,EAASK,MAAQG,EACbC,EAAAA,MAAAC,eAAe,WAAYF,EACjC,CAGA,SAASG,EAASC,GAChBV,EAAMG,MAAQO,EACVH,EAAAA,MAAAC,eAAe,QAASE,EAC9B,CAGA,SAASC,EAAUC,GACjB,MAAMC,EAAyB,CAC7BC,IAAK,QAAUC,KAAKC,MACpBC,SAAU,OACVC,OAAQ,GACRC,OAAQ,MACRC,KAAM,CAAC,KAAM,OAIf,OAFAX,EAASG,GACTP,EAAYQ,GACL,CAAEQ,SAAS,EAAMC,QAAS,OAAQxB,SAAUe,EACrD,CAiEO,MAAA,CACLf,WACAE,QACAC,aACAG,OACAC,cACAI,WACAc,MArEFC,eAAqBZ,WACf,IACI,MAAAa,QAAYC,EAAAC,GAASC,aAAa,CACtCC,KAAM,YACNC,KAAM,CACJC,OAAQ,gBACRnB,UAIA,GAAwB,KAAxB,OAAAoB,EAAIP,EAAAQ,aAAQ,EAAAD,EAAAE,SAAe,CAEvB,MAAAC,EAA0BV,EAAIQ,OAAOnC,UAAY,CACrDgB,IAAKW,EAAIQ,OAAOG,KAAO,QAAUrB,KAAKC,MACtCC,SAAUQ,EAAIQ,OAAOhB,UAAY,OACjCC,OAAQO,EAAIQ,OAAOf,QAAU,GAC7BC,OAAQM,EAAIQ,OAAOd,QAAU,MAC7BC,KAAMK,EAAIQ,OAAOb,MAAQ,CAAC,KAAM,OAIlC,OAFSX,EAAAgB,EAAIQ,OAAOjC,OAASY,GAC7BP,EAAY8B,GACL,CAAEd,SAAS,EAAMC,QAAS,OAAQxB,SAAUqC,EACrD,CAIA,eADAE,MAAA,OAAA,wBAAa,kBAAmB,OAAAC,EAAIb,EAAAQ,iBAAQM,QACrC5B,EAAUC,EAKnB,OAJS4B,GAGP,OAFAjC,EAAAkC,MAAAJ,MAAA,QAAA,wBAAc,kBAAmBG,GAE1B7B,EAAUC,EACnB,CACF,EAsCE8B,OAnCFlB,iBACExB,EAAMG,MAAQ,GACdL,EAASK,MAAQ,aACbwC,kBAAkB,iBAClBA,kBAAkB,WACxB,EA+BEC,iBA5BF,WACQ,MAAAC,EAAatC,EAAAA,MAAIuC,eAAe,SAChCC,EAAgBxC,EAAAA,MAAIuC,eAAe,YAErCD,IACF7C,EAAMG,MAAQ0C,GAEZE,IACFjD,EAASK,MAAQ4C,EAErB,EAmBEC,cAjBF,SAAuBC,GACjBnD,EAASK,QACXL,EAASK,MAAQ,IAAKL,EAASK,SAAU8C,GACrC1C,EAAAA,MAAAC,eAAe,WAAYV,EAASK,OAE5C,EAYE"}