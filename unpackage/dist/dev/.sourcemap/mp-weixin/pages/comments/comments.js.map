{"version":3,"file":"comments.js","sources":["pages/comments/comments.vue","../../../../HbuilderX/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29tbWVudHMvY29tbWVudHMudnVl"],"sourcesContent":["<template>\r\n  <view class=\"comments-container\">\r\n    <!-- 顶部信息 -->\r\n    <view class=\"header\">\r\n      <view class=\"post-info\">\r\n        <text class=\"comment-count\">{{ totalComments }}条评论</text>\r\n      </view>\r\n    </view>\r\n    \r\n    <!-- 评论列表 -->\r\n    <scroll-view \r\n      class=\"comments-scroll\"\r\n      scroll-y=\"true\"\r\n      :refresher-enabled=\"true\"\r\n      :refresher-triggered=\"refreshing\"\r\n      @refresherrefresh=\"refreshComments\"\r\n      @scrolltolower=\"loadMore\"\r\n    >\r\n      <view v-if=\"loading\" class=\"loading-container\">\r\n        <BrutalistLoading text=\"加载中...\" />\r\n      </view>\r\n      \r\n      <view v-else-if=\"commentList.length > 0\" class=\"comment-list\">\r\n        <view v-for=\"(comment, index) in commentList\" :key=\"comment._id\" class=\"comment-item-container\">\r\n          <BrutalistCard :rotate=\"(index % 2 === 0) ? -0.5 : 0.5\" class=\"comment-item\">\r\n            <!-- 评论内容 -->\r\n            <view class=\"comment-content\">\r\n              <view class=\"comment-header\">\r\n                <BrutalistAvatar \r\n                  :src=\"comment.userInfo.avatar\" \r\n                  :text=\"comment.userInfo.nickname\" \r\n                  size=\"small\"\r\n                />\r\n                <view class=\"user-info\">\r\n                  <text class=\"nickname\">{{ comment.userInfo.nickname }}</text>\r\n                  <text class=\"time\">{{ formatTime(comment.createTime) }}</text>\r\n                </view>\r\n              </view>\r\n              \r\n              <text class=\"comment-text\">{{ comment.content }}</text>\r\n              \r\n              <view class=\"comment-actions\">\r\n                <view class=\"action-btn\" @tap=\"replyToComment(comment)\">\r\n                  <text class=\"action-text\">回复</text>\r\n                </view>\r\n              </view>\r\n            </view>\r\n            \r\n            <!-- 回复列表 -->\r\n            <view v-if=\"comment.replies && comment.replies.length > 0\" class=\"replies-container\">\r\n              <view \r\n                v-for=\"reply in comment.replies\" \r\n                :key=\"reply._id\"\r\n                class=\"reply-item\"\r\n              >\r\n                <view class=\"reply-header\">\r\n                  <BrutalistAvatar \r\n                    :src=\"reply.userInfo.avatar\" \r\n                    :text=\"reply.userInfo.nickname\" \r\n                    size=\"small\"\r\n                  />\r\n                  <view class=\"user-info\">\r\n                    <text class=\"nickname\">\r\n                      {{ reply.userInfo.nickname }}\r\n                      <text class=\"reply-to-text\">回复 {{ comment.userInfo.nickname }}</text>\r\n                    </text>\r\n                    <text class=\"time\">{{ formatTime(reply.createTime) }}</text>\r\n                  </view>\r\n                </view>\r\n                \r\n                <text class=\"reply-text\">{{ reply.content }}</text>\r\n                \r\n                <view class=\"reply-actions\">\r\n                  <view class=\"action-btn\" @tap=\"replyToComment(comment, reply)\">\r\n                    <text class=\"action-text\">回复</text>\r\n                  </view>\r\n                </view>\r\n              </view>\r\n            </view>\r\n          </BrutalistCard>\r\n        </view>\r\n      </view>\r\n      \r\n      <!-- 空状态 -->\r\n      <view v-else class=\"empty-container\">\r\n        <BrutalistCard :rotate=\"-1\" class=\"empty-card\">\r\n          <text class=\"empty-text\">还没有评论，快来发表第一条吧！</text>\r\n        </BrutalistCard>\r\n      </view>\r\n      \r\n      <!-- 加载更多 -->\r\n      <view v-if=\"!isEnd && commentList.length > 0\" class=\"load-more\">\r\n        <BrutalistLoading v-if=\"loadingMore\" text=\"加载中...\" />\r\n      </view>\r\n    </scroll-view>\r\n    \r\n    <!-- 评论输入框 -->\r\n    <view class=\"input-container\">\r\n      <BrutalistCard :rotate=\"0\" class=\"input-card\">\r\n        <BrutalistInput \r\n          v-model=\"commentContent\" \r\n          :placeholder=\"replyTarget ? `回复 ${replyTarget.nickname}` : '发表评论'\"\r\n          class=\"comment-input\"\r\n          @confirm=\"submitComment\"\r\n        />\r\n        <BrutalistButton \r\n          text=\"发送\" \r\n          :disabled=\"!commentContent.trim()\"\r\n          @click=\"submitComment\"\r\n          class=\"submit-btn\"\r\n        />\r\n      </BrutalistCard>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      postId: '',\r\n      commentList: [],\r\n      loading: true,\r\n      loadingMore: false,\r\n      refreshing: false,\r\n      isEnd: false,\r\n      currentPage: 1,\r\n      pageSize: 10,\r\n      totalComments: 0,\r\n      commentContent: '',\r\n      replyTarget: null // 回复目标，包含用户信息和评论ID\r\n    }\r\n  },\r\n  onLoad(options) {\r\n    // 检查登录状态\r\n    if (!this.checkLoginStatus()) return\r\n    \r\n    this.postId = options.postId\r\n    if (!this.postId) {\r\n      uni.showToast({\r\n        title: '参数错误',\r\n        icon: 'none'\r\n      })\r\n      uni.navigateBack()\r\n      return\r\n    }\r\n    \r\n    // 加载评论列表\r\n    this.loadComments()\r\n  },\r\n  methods: {\r\n    // 检查登录状态\r\n    checkLoginStatus() {\r\n      const token = uni.getStorageSync('token')\r\n      if (!token) {\r\n        // 没有token，跳转到登录页\r\n        uni.redirectTo({\r\n          url: '/pages/login/login'\r\n        })\r\n        return false\r\n      }\r\n      return true\r\n    },\r\n    \r\n    // 加载评论列表\r\n    async loadComments(isRefresh = false) {\r\n      if (isRefresh) {\r\n        this.currentPage = 1\r\n        this.isEnd = false\r\n      }\r\n      \r\n      try {\r\n        const token = uni.getStorageSync('token')\r\n        const result = await uniCloud.callFunction({\r\n          name: 'get-comments',\r\n          data: {\r\n            token,\r\n            postId: this.postId,\r\n            page: this.currentPage,\r\n            pageSize: this.pageSize\r\n          }\r\n        })\r\n        \r\n        if (result.result.code === 0) {\r\n          const { comments, total } = result.result.data\r\n          \r\n          if (isRefresh) {\r\n            this.commentList = comments\r\n          } else {\r\n            this.commentList = [...this.commentList, ...comments]\r\n          }\r\n          \r\n          this.totalComments = total\r\n          \r\n          // 判断是否已加载全部数据\r\n          if (this.commentList.length >= total) {\r\n            this.isEnd = true\r\n          }\r\n        } else {\r\n          uni.showToast({\r\n            title: result.result.message || '加载失败',\r\n            icon: 'none'\r\n          })\r\n        }\r\n      } catch (error) {\r\n        console.error('加载评论失败:', error)\r\n        uni.showToast({\r\n          title: '加载失败',\r\n          icon: 'none'\r\n        })\r\n      } finally {\r\n        this.loading = false\r\n        this.loadingMore = false\r\n        this.refreshing = false\r\n      }\r\n    },\r\n    \r\n    // 刷新评论\r\n    refreshComments() {\r\n      this.refreshing = true\r\n      this.loadComments(true)\r\n    },\r\n    \r\n    // 加载更多\r\n    loadMore() {\r\n      if (this.loadingMore || this.isEnd) return\r\n      \r\n      this.loadingMore = true\r\n      this.currentPage++\r\n      this.loadComments()\r\n    },\r\n    \r\n    // 回复评论\r\n    replyToComment(comment, reply = null) {\r\n      if (reply) {\r\n        this.replyTarget = {\r\n          ...reply.userInfo,\r\n          commentId: reply._id,\r\n          parentCommentId: comment._id\r\n        }\r\n      } else {\r\n        this.replyTarget = {\r\n          ...comment.userInfo,\r\n          commentId: comment._id,\r\n          parentCommentId: null\r\n        }\r\n      }\r\n      \r\n      // 聚焦到输入框\r\n      this.$nextTick(() => {\r\n        this.commentContent = ''\r\n      })\r\n    },\r\n    \r\n    // 提交评论\r\n    async submitComment() {\r\n      const content = this.commentContent.trim()\r\n      if (!content) {\r\n        uni.showToast({\r\n          title: '请输入评论内容',\r\n          icon: 'none'\r\n        })\r\n        return\r\n      }\r\n      \r\n      try {\r\n        const token = uni.getStorageSync('token')\r\n        const data = {\r\n          token,\r\n          postId: this.postId,\r\n          content\r\n        }\r\n        \r\n        // 如果是回复，添加replyTo参数\r\n        if (this.replyTarget) {\r\n          data.replyTo = this.replyTarget.commentId\r\n        }\r\n        \r\n        const result = await uniCloud.callFunction({\r\n          name: 'add-comment',\r\n          data\r\n        })\r\n        \r\n        if (result.result.code === 0) {\r\n          // 清空输入框\r\n          this.commentContent = ''\r\n          this.replyTarget = null\r\n          \r\n          // 刷新评论列表\r\n          this.refreshComments()\r\n          \r\n          uni.showToast({\r\n            title: '评论成功',\r\n            icon: 'success'\r\n          })\r\n        } else {\r\n          uni.showToast({\r\n            title: result.result.message || '评论失败',\r\n            icon: 'none'\r\n          })\r\n        }\r\n      } catch (error) {\r\n        console.error('评论失败:', error)\r\n        uni.showToast({\r\n          title: '评论失败',\r\n          icon: 'none'\r\n        })\r\n      }\r\n    },\r\n    \r\n    // 格式化时间\r\n    formatTime(time) {\r\n      const now = new Date()\r\n      const date = new Date(time)\r\n      const diff = now - date\r\n      \r\n      // 一分钟内\r\n      if (diff < 60 * 1000) {\r\n        return '刚刚'\r\n      }\r\n      \r\n      // 一小时内\r\n      if (diff < 60 * 60 * 1000) {\r\n        return Math.floor(diff / (60 * 1000)) + '分钟前'\r\n      }\r\n      \r\n      // 一天内\r\n      if (diff < 24 * 60 * 60 * 1000) {\r\n        return Math.floor(diff / (60 * 60 * 1000)) + '小时前'\r\n      }\r\n      \r\n      // 格式化日期\r\n      return `${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style>\r\n.comments-container {\r\n  display: flex;\r\n  flex-direction: column;\r\n  height: 100vh;\r\n  background-color: #FFFFFF;\r\n}\r\n\r\n.header {\r\n  padding: 20rpx;\r\n  border-bottom: 4rpx solid #000000;\r\n}\r\n\r\n.post-info {\r\n  display: flex;\r\n  align-items: center;\r\n}\r\n\r\n.comment-count {\r\n  font-size: 30rpx;\r\n  font-weight: 700;\r\n  color: #000000;\r\n}\r\n\r\n.comments-scroll {\r\n  flex: 1;\r\n  padding: 0 20rpx;\r\n}\r\n\r\n.loading-container, .empty-container {\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  padding: 100rpx 0;\r\n}\r\n\r\n.empty-card {\r\n  width: 90%;\r\n  padding: 60rpx 40rpx;\r\n  display: flex;\r\n  justify-content: center;\r\n}\r\n\r\n.empty-text {\r\n  font-size: 32rpx;\r\n  color: #333333;\r\n}\r\n\r\n.comment-list {\r\n  padding: 20rpx 0;\r\n}\r\n\r\n.comment-item-container {\r\n  margin-bottom: 30rpx;\r\n}\r\n\r\n.comment-item {\r\n  padding: 30rpx;\r\n}\r\n\r\n.comment-content {\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.comment-header {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 20rpx;\r\n}\r\n\r\n.user-info {\r\n  margin-left: 20rpx;\r\n}\r\n\r\n.nickname {\r\n  font-size: 28rpx;\r\n  font-weight: 700;\r\n  color: #000000;\r\n  display: block;\r\n}\r\n\r\n.time {\r\n  font-size: 24rpx;\r\n  color: #999999;\r\n  display: block;\r\n  margin-top: 5rpx;\r\n}\r\n\r\n.comment-text {\r\n  font-size: 30rpx;\r\n  color: #333333;\r\n  line-height: 1.6;\r\n  display: block;\r\n  margin-bottom: 15rpx;\r\n}\r\n\r\n.comment-actions {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n}\r\n\r\n.action-btn {\r\n  padding: 5rpx 15rpx;\r\n  border: 2rpx solid #000000;\r\n}\r\n\r\n.action-text {\r\n  font-size: 26rpx;\r\n  color: #333333;\r\n}\r\n\r\n.replies-container {\r\n  border-top: 2rpx dashed #000000;\r\n  padding-top: 20rpx;\r\n  margin-top: 20rpx;\r\n}\r\n\r\n.reply-item {\r\n  padding: 20rpx;\r\n  background-color: #F5F5F5;\r\n  border: 2rpx solid #000000;\r\n  margin-bottom: 15rpx;\r\n}\r\n\r\n.reply-header {\r\n  display: flex;\r\n  align-items: center;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.reply-to-text {\r\n  font-size: 26rpx;\r\n  color: #666666;\r\n  margin-left: 10rpx;\r\n}\r\n\r\n.reply-text {\r\n  font-size: 28rpx;\r\n  color: #333333;\r\n  line-height: 1.5;\r\n  display: block;\r\n  margin-bottom: 10rpx;\r\n}\r\n\r\n.reply-actions {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n}\r\n\r\n.load-more {\r\n  display: flex;\r\n  justify-content: center;\r\n  padding: 20rpx;\r\n}\r\n\r\n.input-container {\r\n  padding: 20rpx;\r\n  border-top: 4rpx solid #000000;\r\n}\r\n\r\n.input-card {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 20rpx;\r\n}\r\n\r\n.comment-input {\r\n  flex: 1;\r\n  margin-right: 20rpx;\r\n}\r\n\r\n.submit-btn {\r\n  width: 120rpx;\r\n  height: 60rpx;\r\n}\r\n</style>","import MiniProgramPage from 'E:/NJTS-Codeprojects-2023/WechatMiniproject/SupabaseSchoolAPP/SchoolBUZZUniAPPUnicloudTESTTEST/pages/comments/comments.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","uniCloud"],"mappings":"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"}