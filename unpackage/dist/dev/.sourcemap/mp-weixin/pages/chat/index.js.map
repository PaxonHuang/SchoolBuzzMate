{"version":3,"file":"index.js","sources":["pages/chat/index.vue","../../HBuilderX.4.87.2025121004/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY2hhdC9pbmRleC52dWU"],"sourcesContent":["<template>\n  <brutalist-card class=\"chat-container\">\n    <view class=\"chat-header\">\n      <text class=\"title\">实时消息</text>\n    </view>\n\n    <scroll-view class=\"message-list\" scroll-y>\n      <view\n        v-for=\"(message, index) in messages\"\n        :key=\"index\"\n        class=\"message\"\n        :class=\"{ 'sent': message.sender === currentUserId }\"\n      >\n        <brutalist-card :class=\"{ 'accent': message.sender === currentUserId }\">\n          <text class=\"content\">{{ message.content }}</text>\n          <text class=\"time\">{{ formatTime(message.timestamp) }}</text>\n        </brutalist-card>\n      </view>\n    </scroll-view>\n\n    <view class=\"input-area\">\n      <input\n        v-model=\"newMessage\"\n        class=\"message-input\"\n        placeholder=\"输入消息...\"\n        @confirm=\"sendMessage\"\n      />\n      <brutalist-card accent @click=\"sendMessage\">\n        <view class=\"send-btn\">\n          <text>发送</text>\n        </view>\n      </brutalist-card>\n    </view>\n  </brutalist-card>\n</template>\n\n<script setup lang=\"uts\">\nimport { ref, onMounted, onUnmounted } from 'vue';\nimport { useUserStore } from '@/stores/user';\nimport BrutalistCard from '@/components/brutalist/BrutalistCard.vue'\n\n// 接口定义\ninterface Message {\n  _id: string;\n  content: string;\n  sender: string;\n  receiver: string;\n  timestamp: number;\n  read: boolean;\n}\n\n// 数据定义\nconst userStore = useUserStore();\nconst messages = ref<Message[]>([]);\nconst newMessage = ref<string>('');\nconst currentUserId = ref<string>('');\nconst messageListener = ref<any>(null);\n\nonMounted(async () => {\n  if (!userStore.isLoggedIn) {\n    uni.showToast({ title: '请先登录', icon: 'none' });\n    uni.navigateTo({ url: '/pages/index/index' });\n    return;\n  }\n\n  currentUserId.value = userStore.user._id;\n\n  // 初始化消息监听\n  const db = uniCloud.database();\n  const messageCollection = db.collection('messages');\n\n  // 监听当前用户的消息\n  messageListener.value = messageCollection\n    .where(`receiver == '${currentUserId.value}' || sender == '${currentUserId.value}'`)\n    .orderBy('timestamp', 'asc')\n    .watch({\n      onChange: (snapshot: any) => {\n        messages.value = snapshot.data as Message[];\n      },\n      onError: (e: any) => {\n        uni.__f__('error','at pages/chat/index.vue:81','消息监听失败:', e);\n      }\n    });\n});\n\nonUnmounted(() => {\n  // 清理消息监听\n  if (messageListener.value) {\n    messageListener.value.close();\n    messageListener.value = null;\n  }\n});\n\n// 方法定义\nconst formatTime = (timestamp: number): string => {\n  const date = new Date(timestamp);\n  return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;\n};\n\nconst sendMessage = async () => {\n  if (!newMessage.value.trim()) return;\n\n  try {\n    const db = uniCloud.database();\n    await db.collection('messages').add({\n      content: newMessage.value.trim(),\n      sender: currentUserId.value,\n      receiver: 'admin', // 实际应用中应替换为具体接收者\n      timestamp: Date.now(),\n      read: false\n    });\n\n    newMessage.value = '';\n  } catch (e) {\n    uni.__f__('error','at pages/chat/index.vue:115','发送失败:', e);\n    uni.showToast({ title: '发送失败', icon: 'none' });\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n$black: #000;\n\n.chat-container {\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  padding: 24rpx;\n}\n\n.chat-header {\n  text-align: center;\n  margin-bottom: 24rpx;\n\n  .title {\n    font-size: 36rpx;\n    font-weight: bold;\n  }\n}\n\n.message-list {\n  flex: 1;\n  overflow-y: auto;\n  margin-bottom: 24rpx;\n\n  .message {\n    margin-bottom: 24rpx;\n\n    &.sent {\n      display: flex;\n      justify-content: flex-end;\n    }\n\n    .content {\n      display: block;\n      margin-bottom: 8rpx;\n    }\n\n    .time {\n      font-size: 24rpx;\n      color: #666;\n      text-align: right;\n    }\n  }\n}\n\n.input-area {\n  display: flex;\n  gap: 16rpx;\n\n  .message-input {\n    flex: 1;\n    border: 2rpx solid $black;\n    border-radius: 4rpx;\n    padding: 16rpx;\n    font-size: 28rpx;\n  }\n\n  .send-btn {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    padding: 0 24rpx;\n\n    text {\n      font-weight: bold;\n    }\n  }\n}\n</style>","import MiniProgramPage from 'E:/codeplace/test/pages/chat/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["BrutalistCard","userStore","useUserStore","messages","ref","newMessage","currentUserId","messageListener","onMounted","async","isLoggedIn","uni","index","showToast","title","icon","navigateTo","url","value","user","_id","messageCollection","uniCloud","database","collection","where","orderBy","watch","onChange","snapshot","data","onError","e","__f__","onUnmounted","close","formatTime","timestamp","date","Date","getHours","getMinutes","toString","padStart","sendMessage","trim","db","add","content","sender","receiver","now","read","wx","createPage","MiniProgramPage"],"mappings":"mGAuCA,MAAAA,EAA0B,IAAA,2FAapB,MAAAC,EAAYC,EAAAA,eACZC,EAAWC,MAAe,IAC1BC,EAAaD,MAAY,IACzBE,EAAgBF,MAAY,IAC5BG,EAAkBH,MAAS,MAEjCI,EAAAA,WAAUC,UACJ,IAACR,EAAUS,WAGb,OAFAC,EAAAC,MAAIC,UAAU,CAAEC,MAAO,OAAQC,KAAM,cACrCJ,EAAAA,MAAIK,WAAW,CAAEC,IAAK,uBAIVX,EAAAY,MAAQjB,EAAUkB,KAAKC,IAG/B,MACAC,EADKC,KAASC,WACSC,WAAW,YAGxCjB,EAAgBW,MAAQG,EACrBI,MAAM,gBAAgBnB,EAAcY,wBAAwBZ,EAAcY,UAC1EQ,QAAQ,YAAa,OACrBC,MAAM,CACLC,SAAWC,IACT1B,EAASe,MAAQW,EAASC,IAAA,EAE5BC,QAAUC,IACRrB,EAAAC,MAAIqB,MAAM,QAAQ,6BAA6B,UAAWD,EAAC,GAE9D,IAGLE,EAAAA,aAAY,KAEN3B,EAAgBW,QAClBX,EAAgBW,MAAMiB,QACtB5B,EAAgBW,MAAQ,KAC1B,IAII,MAAAkB,EAAcC,IACZ,MAAAC,EAAO,IAAIC,KAAKF,GACtB,MAAO,GAAGC,EAAKE,cAAcF,EAAKG,aAAaC,WAAWC,SAAS,EAAG,MAAI,EAGtEC,EAAcnC,UACd,GAACJ,EAAWa,MAAM2B,OAElB,IACI,MAAAC,EAAKxB,KAASC,iBACduB,EAAGtB,WAAW,YAAYuB,IAAI,CAClCC,QAAS3C,EAAWa,MAAM2B,OAC1BI,OAAQ3C,EAAcY,MACtBgC,SAAU,QACVb,UAAWE,KAAKY,MAChBC,MAAM,IAGR/C,EAAWa,MAAQ,EAIrB,OAHSc,GACPrB,EAAAC,MAAIqB,MAAM,QAAQ,8BAA8B,QAASD,GACzDrB,EAAAC,MAAIC,UAAU,CAAEC,MAAO,OAAQC,KAAM,QACvC,2TCnHFsC,GAAGC,WAAWC"}