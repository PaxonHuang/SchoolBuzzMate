"use strict";const e=require("../../common/vendor.js"),o={data:()=>({userInfo:{},isLoading:!1,showPhoneModal:!1,phoneNumber:"",verifyCode:"",codeTimer:0,codeTimerId:null}),computed:{isValidPhone(){return/^1[3-9]\d{9}$/.test(this.phoneNumber)}},onLoad(){this.getUserInfo()},methods:{async getUserInfo(){try{const o=e.index.getStorageSync("token");if(!o)return void e.index.redirectTo({url:"/pages/login/login"});const n=await e.tr.callFunction({name:"validate-token",data:{token:o}});n.result.success?(this.userInfo=n.result.userInfo,this.userInfo.isPhoneVerified&&e.index.switchTab({url:"/pages/index/index"})):(e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo"),e.index.redirectTo({url:"/pages/login/login"}))}catch(o){console.error("获取用户信息失败:",o),e.index.redirectTo({url:"/pages/login/login"})}},bindPhone(){this.showPhoneModal=!0},hideBindPhone(){this.showPhoneModal=!1,this.phoneNumber="",this.verifyCode=""},async sendCode(){if(this.isValidPhone)try{const o=await e.tr.callFunction({name:"send-sms-code",data:{phone:this.phoneNumber}});o.result.success?(this.codeTimer=60,this.codeTimerId=setInterval(()=>{this.codeTimer--,this.codeTimer<=0&&(clearInterval(this.codeTimerId),this.codeTimerId=null)},1e3),e.index.showToast({title:"验证码已发送",icon:"success"})):e.index.showToast({title:o.result.message||"发送失败",icon:"none"})}catch(o){console.error("发送验证码失败:",o),e.index.showToast({title:"发送失败，请重试",icon:"none"})}else e.index.showToast({title:"请输入正确的手机号",icon:"none"})},async handleBindPhone(){if(this.isValidPhone)if(this.verifyCode&&6===this.verifyCode.length){this.isLoading=!0;try{const o=e.index.getStorageSync("token"),n=await e.tr.callFunction({name:"bind-phone",data:{token:o,phone:this.phoneNumber,code:this.verifyCode}});n.result.success?(this.userInfo=n.result.userInfo,e.index.setStorageSync("userInfo",this.userInfo),e.index.showToast({title:"绑定成功",icon:"success"}),setTimeout(()=>{e.index.switchTab({url:"/pages/index/index"})},1500)):e.index.showToast({title:n.result.message||"绑定失败",icon:"none"})}catch(o){console.error("绑定手机号失败:",o),e.index.showToast({title:"绑定失败，请重试",icon:"none"})}finally{this.isLoading=!1}}else e.index.showToast({title:"请输入正确的验证码",icon:"none"});else e.index.showToast({title:"请输入正确的手机号",icon:"none"})},skipBind(){e.index.switchTab({url:"/pages/index/index"})}},onUnload(){this.codeTimerId&&clearInterval(this.codeTimerId)}};const n=e._export_sfc(o,[["render",function(o,n,i,s,t,d){return e.e({a:t.userInfo.avatar,b:e.t(t.userInfo.nickname),c:!t.userInfo.isPhoneVerified},t.userInfo.isPhoneVerified?{}:{d:e.o((...e)=>d.bindPhone&&d.bindPhone(...e))},{e:e.o((...e)=>d.skipBind&&d.skipBind(...e)),f:t.showPhoneModal},t.showPhoneModal?{g:t.phoneNumber,h:e.o(e=>t.phoneNumber=e.detail.value),i:t.verifyCode,j:e.o(e=>t.verifyCode=e.detail.value),k:e.t(t.codeTimer>0?`${t.codeTimer}s`:"获取验证码"),l:e.o((...e)=>d.sendCode&&d.sendCode(...e)),m:t.codeTimer>0||!d.isValidPhone,n:e.o((...e)=>d.hideBindPhone&&d.hideBindPhone(...e)),o:e.o((...e)=>d.handleBindPhone&&d.handleBindPhone(...e)),p:e.o(()=>{}),q:e.o((...e)=>d.hideBindPhone&&d.hideBindPhone(...e))}:{},{r:t.isLoading},(t.isLoading,{}))}]]);wx.createPage(n);
