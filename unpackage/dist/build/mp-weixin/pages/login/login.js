"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n={data:()=>({isLoading:!1,showPhoneModal:!1,phoneNumber:"",verifyCode:"",codeTimer:0,codeTimerId:null}),computed:{isValidPhone(){return/^1[3-9]\d{9}$/.test(this.phoneNumber)}},onLoad(){this.checkLoginStatus()},methods:{checkLoginStatus(){const o=e.index.getStorageSync("token");o&&this.validateToken(o)},async validateToken(o){try{(await e.tr.callFunction({name:"validate-token",data:{token:o}})).result.success&&e.index.switchTab({url:"/pages/index/index"})}catch(n){console.error("Token验证失败:",n),e.index.removeStorageSync("token"),e.index.removeStorageSync("userInfo")}},async handleWxLogin(){this.isLoading=!0;try{const o=await e.index.login({provider:"weixin"});if(!o.code)throw new Error("获取微信登录凭证失败");const n=await e.index.getUserInfo({provider:"weixin"}),i=await e.tr.callFunction({name:"wx-login",data:{code:o.code,userInfo:n.userInfo}});i.result.success?(e.index.setStorageSync("token",i.result.token),e.index.setStorageSync("userInfo",i.result.userInfo),e.index.switchTab({url:"/pages/index/index"})):e.index.showToast({title:i.result.message||"登录失败",icon:"none"})}catch(o){console.error("微信登录失败:",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}finally{this.isLoading=!1}},showPhoneLogin(){this.showPhoneModal=!0},hidePhoneLogin(){this.showPhoneModal=!1,this.phoneNumber="",this.verifyCode=""},async sendCode(){if(this.isValidPhone)try{const o=await e.tr.callFunction({name:"send-sms-code",data:{phone:this.phoneNumber}});o.result.success?(this.codeTimer=60,this.codeTimerId=setInterval(()=>{this.codeTimer--,this.codeTimer<=0&&(clearInterval(this.codeTimerId),this.codeTimerId=null)},1e3),e.index.showToast({title:"验证码已发送",icon:"success"})):e.index.showToast({title:o.result.message||"发送失败",icon:"none"})}catch(o){console.error("发送验证码失败:",o),e.index.showToast({title:"发送失败，请重试",icon:"none"})}else e.index.showToast({title:"请输入正确的手机号",icon:"none"})},async handlePhoneLogin(){if(this.isValidPhone)if(this.verifyCode&&6===this.verifyCode.length){this.isLoading=!0;try{const o=await e.tr.callFunction({name:"phone-login",data:{phone:this.phoneNumber,code:this.verifyCode}});o.result.success?(e.index.setStorageSync("token",o.result.token),e.index.setStorageSync("userInfo",o.result.userInfo),e.index.switchTab({url:"/pages/index/index"})):e.index.showToast({title:o.result.message||"登录失败",icon:"none"})}catch(o){console.error("手机号登录失败:",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}finally{this.isLoading=!1}}else e.index.showToast({title:"请输入正确的验证码",icon:"none"});else e.index.showToast({title:"请输入正确的手机号",icon:"none"})},openUserAgreement(){e.index.navigateTo({url:"/pages/webview/webview?title=用户协议&url=https://example.com/user-agreement"})},openPrivacyPolicy(){e.index.navigateTo({url:"/pages/webview/webview?title=隐私政策&url=https://example.com/privacy-policy"})}},onUnload(){this.codeTimerId&&clearInterval(this.codeTimerId)}};const i=e._export_sfc(n,[["render",function(n,i,t,s,a,r){return e.e({a:o._imports_0,b:e.o((...e)=>r.handleWxLogin&&r.handleWxLogin(...e)),c:a.isLoading,d:e.o((...e)=>r.showPhoneLogin&&r.showPhoneLogin(...e)),e:a.isLoading,f:e.o((...e)=>r.openUserAgreement&&r.openUserAgreement(...e)),g:e.o((...e)=>r.openPrivacyPolicy&&r.openPrivacyPolicy(...e)),h:a.showPhoneModal},a.showPhoneModal?{i:a.phoneNumber,j:e.o(e=>a.phoneNumber=e.detail.value),k:a.verifyCode,l:e.o(e=>a.verifyCode=e.detail.value),m:e.t(a.codeTimer>0?`${a.codeTimer}s`:"获取验证码"),n:e.o((...e)=>r.sendCode&&r.sendCode(...e)),o:a.codeTimer>0||!r.isValidPhone,p:e.o((...e)=>r.hidePhoneLogin&&r.hidePhoneLogin(...e)),q:e.o((...e)=>r.handlePhoneLogin&&r.handlePhoneLogin(...e)),r:e.o(()=>{}),s:e.o((...e)=>r.hidePhoneLogin&&r.hidePhoneLogin(...e))}:{},{t:a.isLoading},(a.isLoading,{}))}]]);wx.createPage(i);
