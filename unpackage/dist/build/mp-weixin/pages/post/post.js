"use strict";const t=require("../../common/vendor.js"),e={data:()=>({postContent:"",imageList:[],uploadedImages:[],isSubmitting:!1}),computed:{canPost(){return this.postContent.trim().length>0||this.imageList.length>0}},onLoad(){this.checkLoginStatus()},methods:{checkLoginStatus(){t.index.getStorageSync("token")||t.index.redirectTo({url:"/pages/login/login"})},chooseImage(){const e=9-this.imageList.length;t.index.chooseImage({count:e,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{this.imageList=[...this.imageList,...t.tempFilePaths]},fail:e=>{console.error("选择图片失败:",e),t.index.showToast({title:"选择图片失败",icon:"none"})}})},previewImage(e){t.index.previewImage({current:e,urls:this.imageList})},deleteImage(t){this.imageList.splice(t,1)},async uploadImages(){if(0===this.imageList.length)return[];t.index.showLoading({title:"上传图片中...",mask:!0});const e=t.index.getStorageSync("token"),s=[];for(const o of this.imageList){const i=await this.fileToBase64(o),n=t.tr.callFunction({name:"upload-image",data:{token:e,fileContent:i}});s.push(n)}try{const t=await Promise.all(s);return t.map(t=>{if(0===t.result.code)return t.result.data.tempFileURL;throw new Error(t.result.message)})}catch(i){throw console.error("上传图片失败:",i),t.index.showToast({title:"上传图片失败",icon:"none"}),i}finally{t.index.hideLoading()}},fileToBase64:e=>new Promise((s,i)=>{t.index.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:t=>{s(t.data)},fail:i})}),cancelPost(){t.index.showModal({title:"提示",content:"确定要取消发布吗？",success:e=>{e.confirm&&t.index.navigateBack()}})},async submitPost(){if(this.canPost){if(!this.isSubmitting){this.isSubmitting=!0;try{const e=await this.uploadImages(),s=t.index.getStorageSync("token"),i=await t.tr.callFunction({name:"publish-post",data:{token:s,content:this.postContent.trim(),images:e,isPublic:!0}});0===i.result.code?(t.index.showToast({title:"发布成功",icon:"success"}),setTimeout(()=>{t.index.navigateBack()},1500)):t.index.showToast({title:i.result.message||"发布失败",icon:"none"})}catch(e){console.error("发布失败:",e),t.index.showToast({title:"发布失败",icon:"none"})}finally{this.isSubmitting=!1}}}else t.index.showToast({title:"请输入内容或添加图片",icon:"none"})}}};if(!Array){(t.resolveComponent("BrutalistInput")+t.resolveComponent("BrutalistButton")+t.resolveComponent("BrutalistCard"))()}Math||((()=>"../../components/BrutalistInput/BrutalistInput.js")+(()=>"../../components/BrutalistButton/BrutalistButton.js")+(()=>"../../components/BrutalistCard/BrutalistCard.js"))();const s=t._export_sfc(e,[["render",function(e,s,i,o,n,a){return t.e({a:t.o(t=>n.postContent=t),b:t.p({type:"textarea",placeholder:"分享你的校园生活...",maxlength:500,modelValue:n.postContent}),c:t.t(n.postContent.length),d:t.f(n.imageList,(e,s,i)=>({a:e,b:t.o(t=>a.previewImage(s),s),c:t.o(t=>a.deleteImage(s),s),d:s})),e:n.imageList.length<9},n.imageList.length<9?{f:t.o((...t)=>a.chooseImage&&a.chooseImage(...t))}:{},{g:t.o(a.cancelPost),h:t.p({text:"取消",type:"secondary"}),i:t.o(a.submitPost),j:t.p({text:"发布",disabled:!a.canPost}),k:t.p({rotate:-1})})}]]);wx.createPage(s);
