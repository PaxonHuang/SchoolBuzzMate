"use strict";const t=require("../../common/vendor.js"),e={data:()=>({postId:"",commentList:[],loading:!0,loadingMore:!1,refreshing:!1,isEnd:!1,currentPage:1,pageSize:10,totalComments:0,commentContent:"",replyTarget:null}),onLoad(e){if(this.checkLoginStatus()){if(this.postId=e.postId,!this.postId)return t.index.showToast({title:"参数错误",icon:"none"}),void t.index.navigateBack();this.loadComments()}},methods:{checkLoginStatus:()=>!!t.index.getStorageSync("token")||(t.index.redirectTo({url:"/pages/login/login"}),!1),async loadComments(e=!1){e&&(this.currentPage=1,this.isEnd=!1);try{const n=t.index.getStorageSync("token"),o=await t.tr.callFunction({name:"get-comments",data:{token:n,postId:this.postId,page:this.currentPage,pageSize:this.pageSize}});if(0===o.result.code){const{comments:t,total:n}=o.result.data;this.commentList=e?t:[...this.commentList,...t],this.totalComments=n,this.commentList.length>=n&&(this.isEnd=!0)}else t.index.showToast({title:o.result.message||"加载失败",icon:"none"})}catch(n){console.error("加载评论失败:",n),t.index.showToast({title:"加载失败",icon:"none"})}finally{this.loading=!1,this.loadingMore=!1,this.refreshing=!1}},refreshComments(){this.refreshing=!0,this.loadComments(!0)},loadMore(){this.loadingMore||this.isEnd||(this.loadingMore=!0,this.currentPage++,this.loadComments())},replyToComment(t,e=null){this.replyTarget=e?{...e.userInfo,commentId:e._id,parentCommentId:t._id}:{...t.userInfo,commentId:t._id,parentCommentId:null},this.$nextTick(()=>{this.commentContent=""})},async submitComment(){const e=this.commentContent.trim();if(e)try{const n={token:t.index.getStorageSync("token"),postId:this.postId,content:e};this.replyTarget&&(n.replyTo=this.replyTarget.commentId);const o=await t.tr.callFunction({name:"add-comment",data:n});0===o.result.code?(this.commentContent="",this.replyTarget=null,this.refreshComments(),t.index.showToast({title:"评论成功",icon:"success"})):t.index.showToast({title:o.result.message||"评论失败",icon:"none"})}catch(n){console.error("评论失败:",n),t.index.showToast({title:"评论失败",icon:"none"})}else t.index.showToast({title:"请输入评论内容",icon:"none"})},formatTime(t){const e=new Date,n=new Date(t),o=e-n;return o<6e4?"刚刚":o<36e5?Math.floor(o/6e4)+"分钟前":o<864e5?Math.floor(o/36e5)+"小时前":`${n.getMonth()+1}-${n.getDate()} ${n.getHours()}:${n.getMinutes().toString().padStart(2,"0")}`}}};if(!Array){(t.resolveComponent("BrutalistLoading")+t.resolveComponent("BrutalistAvatar")+t.resolveComponent("BrutalistCard")+t.resolveComponent("BrutalistInput")+t.resolveComponent("BrutalistButton"))()}Math||((()=>"../../components/BrutalistLoading/BrutalistLoading.js")+(()=>"../../components/BrutalistAvatar/BrutalistAvatar.js")+(()=>"../../components/BrutalistCard/BrutalistCard.js")+(()=>"../../components/BrutalistInput/BrutalistInput.js")+(()=>"../../components/BrutalistButton/BrutalistButton.js"))();const n=t._export_sfc(e,[["render",function(e,n,o,s,i,r){return t.e({a:t.t(i.totalComments),b:i.loading},i.loading?{c:t.p({text:"加载中..."})}:i.commentList.length>0?{e:t.f(i.commentList,(e,n,o)=>t.e({a:"203f8302-2-"+o+",203f8302-1-"+o,b:t.p({src:e.userInfo.avatar,text:e.userInfo.nickname,size:"small"}),c:t.t(e.userInfo.nickname),d:t.t(r.formatTime(e.createTime)),e:t.t(e.content),f:t.o(t=>r.replyToComment(e),e._id),g:e.replies&&e.replies.length>0},e.replies&&e.replies.length>0?{h:t.f(e.replies,(n,s,i)=>({a:"203f8302-3-"+o+"-"+i+",203f8302-1-"+o,b:t.p({src:n.userInfo.avatar,text:n.userInfo.nickname,size:"small"}),c:t.t(n.userInfo.nickname),d:t.t(r.formatTime(n.createTime)),e:t.t(n.content),f:t.o(t=>r.replyToComment(e,n),n._id),g:n._id})),i:t.t(e.userInfo.nickname)}:{},{j:"203f8302-1-"+o,k:t.p({rotate:n%2==0?-.5:.5}),l:e._id}))}:{f:t.p({rotate:-1})},{d:i.commentList.length>0,g:!i.isEnd&&i.commentList.length>0},!i.isEnd&&i.commentList.length>0?t.e({h:i.loadingMore},i.loadingMore?{i:t.p({text:"加载中..."})}:{}):{},{j:i.refreshing,k:t.o((...t)=>r.refreshComments&&r.refreshComments(...t)),l:t.o((...t)=>r.loadMore&&r.loadMore(...t)),m:t.o(r.submitComment),n:t.o(t=>i.commentContent=t),o:t.p({placeholder:i.replyTarget?`回复 ${i.replyTarget.nickname}`:"发表评论",modelValue:i.commentContent}),p:t.o(r.submitComment),q:t.p({text:"发送",disabled:!i.commentContent.trim()}),r:t.p({rotate:0})})}]]);wx.createPage(n);
