# 校趣闪搭 - 配置指南

本文档提供详细的配置说明，帮助您快速搭建和部署项目。

## 目录

1. [微信小程序配置](#微信小程序配置)
2. [微信支付配置](#微信支付配置)
3. [uni-pay 授权配置](#uni-pay-授权配置)
4. [UniCloud 配置](#unicloud-配置)
5. [数据库配置](#数据库配置)
6. [部署步骤](#部署步骤)
7. [易错要点](#易错要点)

## 微信小程序配置

### 1. 注册微信小程序

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册小程序账号
3. 完成认证（个人或企业）
4. 获取 AppID 和 AppSecret

### 2. 配置 manifest.json

在项目根目录的 `manifest.json` 文件中配置：

```json
{
  "mp-weixin": {
    "appid": "你的微信小程序AppID",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "postcss": true,
      "minified": true,
      "enhance": false,
      "ignoreUploadUnusedFiles": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "您的位置信息将用于展示附近的服务和匹配"
      }
    },
    "requiredPrivateInfos": ["getLocation", "chooseLocation"]
  }
}
```

### 3. 配置服务器域名

在微信小程序后台配置以下服务器域名：

- **request 合法域名**: 你的 UniCloud 服务空间域名
- **uploadFile 合法域名**: 你的 UniCloud 云存储域名
- **downloadFile 合法域名**: 你的 UniCloud 云存储域名

### 4. 配置隐私设置

在微信小程序后台配置：
- 用户隐私保护指引
- 用户信息保护规则

## 微信支付配置

### 1. 申请微信支付

1. 在微信小程序后台开通微信支付功能
2. 获取商户号（MCH_ID）
3. 获取 API 密钥（API_KEY）
4. 配置支付回调地址

### 2. 配置支付参数

在 UniCloud Web 控制台配置支付参数：

1. 进入"云函数" → "云函数配置"
2. 添加以下环境变量：
   - `WX_PAY_MCH_ID`: 微信支付商户号
   - `WX_PAY_KEY`: 微信支付 API 密钥
   - `WX_PAY_NOTIFY_URL`: 支付回调地址

### 3. 配置支付回调

1. 在微信支付商户平台配置支付回调地址
2. 确保回调地址可访问
3. 测试支付流程

## uni-pay 授权配置

### 1. 安装 uni-pay

在项目中安装 uni-pay 插件：

```bash
npm install @dcloudio/uni-pay
```

### 2. 配置 uni-pay

在 `uniCloud-aliyun/cloudfunctions/createPayment/index.js` 中配置：

```javascript
const payment = uniCloud.initPayment();
const res = await payment.createOrder({
  subject: `校趣闪搭 - 打印订单 #${orderId.substring(0, 6)}`,
  body: '校园服务平台订单',
  outTradeId: orderId,
  amount: order.amount,
  clientIp: context.CLIENTIP,
  paymentType: 'wxpay'
});
```

### 3. 配置支付回调

在云函数中处理支付回调：

```javascript
exports.main = async (event, context) => {
  const { orderId } = event;
  const db = uniCloud.database();
  
  // 更新订单状态
  await db.collection('orders').doc(orderId).update({
    status: 'paid',
    paymentTime: Date.now()
  });
  
  return { code: 0, message: '支付成功' };
};
```

## UniCloud 配置

### 1. 关联云服务空间

1. 在 HBuilderX 中打开项目
2. 右键 `uniCloud-aliyun` 目录 → "关联云服务空间"
3. 选择或创建阿里云服务空间

### 2. 配置 uni-config.json

在 `uniCloud-aliyun/uni-config.json` 中配置：

```json
{
  "mp-weixin": {
    "oauth": {
      "weixin": {
        "appid": "YOUR_WECHAT_APPID",
        "appsecret": "YOUR_WECHAT_APPSECRET"
      }
    },
    "oauthWeixin": {
      "appid": "YOUR_WECHAT_APPID",
      "appsecret": "YOUR_WECHAT_APPSECRET"
    }
  }
}
```

### 3. 配置 uni-id.config.json

在 `uniCloud-aliyun/uni-id.config.json` 中配置：

```json
{
  "tokenSecret": "${UNI_ID_TOKEN_SECRET}",
  "oauth": {
    "weixin": {
      "appid": "${WECHAT_APPID}",
      "secret": "${WECHAT_SECRET}"
    }
  },
  "tokenExpiresIn": 7200,
  "tokenExpiresThreshold": 3600,
  "passwordStrength": "medium"
}
```

### 4. 设置环境变量

在 UniCloud Web 控制台设置环境变量：

- `UNI_ID_TOKEN_SECRET`: 自定义的 token 密钥（建议使用随机字符串）
- `WECHAT_APPID`: 微信小程序 AppID
- `WECHAT_SECRET`: 微信小程序 AppSecret
- `WX_PAY_MCH_ID`: 微信支付商户号
- `WX_PAY_KEY`: 微信支付 API 密钥
- `WX_PAY_NOTIFY_URL`: 支付回调地址

## 数据库配置

### 1. 创建数据表

在 UniCloud Web 控制台创建以下数据表：

- `users`（用户信息）
- `requests`（需求请求）
- `orders`（订单）
- `messages`（消息）
- `posts`（论坛帖子）

### 2. 导入 Schema

为每个数据表导入对应的 schema 文件：

1. 进入"云数据库" → "数据表"
2. 选择对应的数据表
3. 点击"导入 Schema"
4. 选择项目中的 schema 文件

### 3. 配置权限

根据业务需求配置数据表权限：

```json
{
  "read": "auth.uid != null",
  "create": "auth.uid != null",
  "update": "doc.creator == auth.uid",
  "delete": "doc.creator == auth.uid"
}
```

## 部署步骤

### 1. 上传云函数

1. 右键 `uniCloud-aliyun/cloudfunctions/uni-id-cf` → "上传部署"
2. 右键 `uniCloud-aliyun/cloudfunctions/createPayment` → "上传部署"

### 2. 本地开发

```bash
# 安装依赖
npm install

# 开发模式（运行到微信小程序）
npm run dev:mp-weixin
```

### 3. 发布小程序

```bash
# 1. 构建生产版本
npm run build:mp-weixin

# 2. 在微信开发者工具中
#    - 打开生成的 dist/dev/mp-weixin 目录
#    - 预览测试
#    - 上传代码
#    - 在微信公众平台提交审核
```

## 易错要点

### 1. AppID 配置错误

**问题**: 小程序无法正常启动或登录失败

**解决方案**:
- 确保 `manifest.json` 中的 `mp-weixin.appid` 与微信小程序后台一致
- 确保 `uni-config.json` 中的 `appid` 和 `appsecret` 正确
- 不要将 AppSecret 提交到代码仓库，使用环境变量

### 2. 域名配置问题

**问题**: 网络请求失败

**解决方案**:
- 在微信小程序后台配置所有必需的服务器域名
- 确保域名已备案
- 开发阶段可在 `manifest.json` 中设置 `"urlCheck": false`

### 3. 权限配置问题

**问题**: 无法获取用户位置信息

**解决方案**:
- 在 `manifest.json` 中配置 `permission.scope.userLocation`
- 添加 `requiredPrivateInfos: ["getLocation", "chooseLocation"]`
- 在代码中正确处理用户授权

### 4. 支付参数配置错误

**问题**: 支付创建失败

**解决方案**:
- 确保商户号（MCH_ID）正确
- 确保 API 密钥（API_KEY）正确
- 检查支付回调地址是否可访问
- 确保订单金额格式正确（单位为分）

### 5. 环境变量未设置

**问题**: 云函数调用失败

**解决方案**:
- 在 UniCloud Web 控制台设置所有必需的环境变量
- 确保 `UNI_ID_TOKEN_SECRET` 已设置
- 确保 `WECHAT_APPID` 和 `WECHAT_SECRET` 已设置

### 6. 数据库权限问题

**问题**: 数据库操作失败

**解决方案**:
- 检查数据库 Schema 的权限配置
- 确保用户有相应的读写权限
- 开发阶段可临时放宽权限限制

### 7. 云函数未上传

**问题**: 云函数调用失败

**解决方案**:
- 确保所有云函数已上传部署
- 检查云函数日志确认是否正常运行

## 调试技巧

### 1. 查看云函数日志

1. 登录 UniCloud Web 控制台
2. 进入"云函数" → "日志"
3. 选择对应的云函数查看日志

### 2. 本地调试

- 使用微信开发者工具的调试功能
- 在 HBuilderX 中查看控制台输出
- 使用 `console.log` 输出调试信息

### 3. 网络请求调试

- 在微信开发者工具的"网络"面板查看请求详情
- 检查请求参数和响应数据
- 确保请求头和请求方法正确

## 常见问题

### 1. 云函数调用失败

检查：
- 云函数是否已上传
- 服务空间是否关联
- 权限配置是否正确
- 环境变量是否已设置

### 2. 数据库操作失败

检查：
- Schema 是否已创建
- 权限规则是否正确
- 数据格式是否匹配

### 3. 支付失败

检查：
- uni-pay 配置是否正确
- 商户号配置是否正确
- 回调 URL 是否可访问
- 订单金额格式是否正确

## 联系支持

如有问题，请通过以下方式联系：
- 提交 Issue
- 查看项目文档
- 联系项目维护者